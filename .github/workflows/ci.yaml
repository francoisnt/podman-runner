name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      PODMAN_IGNORE_DOCKER: "1"

    steps:
      - name: Checkout code
        uses: actions/checkout@v5 

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman
          # Start rootless socket for container runs
          systemctl --user start podman.socket
          podman system migrate  # One-time setup for storage

      - name: Setup uv
        uses: astral-sh/setup-uv@v6 
        with:
          version: "0.9.11"  

      - name: Install dependencies
        run: uv sync --all-extras --frozen

      - name: Run unit tests
        run: uv run pytest tests/unit --cov --cov-branch --cov-report=xml -n auto --dist=loadscope
      
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:   
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Run integration tests
        run: uv run task integration  